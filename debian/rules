#!/usr/bin/make -f
# -*- makefile -*-

include /usr/share/dpkg/pkg-info.mk
export LIBCOMMON_REVISION=$(DEB_VERSION_UPSTREAM)

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1
export DEB_BUILD_MAINT_OPTIONS=hardening=+all

CMAKE_FLAGS = -DUNBUNDLED=1 \
	      -DUSE_STATIC_LIBRARIES=0 \
	      -DUSE_INTERNAL_BOOST_LIBRARY=0 \
	      -DUSE_INTERNAL_BTRIE_LIBRARY=1 \
	      -DUSE_INTERNAL_CAPNP_LIBRARY=0 \
	      -DUSE_INTERNAL_CCTZ_LIBRARY=0 \
	      -DUSE_INTERNAL_CITYHASH_LIBRARY=1 \
	      -DUSE_INTERNAL_DOUBLE_CONVERSION_LIBRARY=0 \
	      -DUSE_INTERNAL_FARMHASH_LIBRARY=0 \
	      -DUSE_INTERNAL_GPERFTOOLS_LIBRARY=0 \
	      -DUSE_INTERNAL_METROHASH_LIBRARY=1 \
	      -DUSE_INTERNAL_LZ4_LIBRARY=0 \
	      -DUSE_INTERNAL_POCO_LIBRARY=0 \
	      -DUSE_INTERNAL_RDKAFKA_LIBRARY=0 \
	      -DUSE_INTERNAL_RE2_LIBRARY=0 \
	      -DUSE_INTERNAL_UNWIND_LIBRARY=0 \
	      -DUSE_INTERNAL_ZLIB_LIBRARY=0 \
	      -DUSE_INTERNAL_ZOOKEEPER_LIBRARY=0 \
	      -DUSE_INTERNAL_ZSTD_LIBRARY=0

ifndef DH_VERBOSE
    CMAKE_FLAGS += -DCMAKE_VERBOSE_MAKEFILE=0
endif

BUILDDIR = build

%:
	dh $@ --parallel --buildsystem=cmake --with=systemd --builddirectory=$(BUILDDIR)

override_dh_auto_configure:
	dh_auto_configure -- $(CMAKE_FLAGS)

override_dh_auto_test:
	./debian/tests_wrapper.sh

override_dh_install:
	# Install limits file
	mkdir -p debian/tmp/etc/security/limits.d/
	cp debian/clickhouse.limits debian/tmp/etc/security/limits.d/clickhouse.conf
	# Moving headers
	mkdir -p debian/tmp/usr/share/clickhouse/headers
	./copy_headers.sh . debian/tmp/usr/share/clickhouse/headers
	# Remove upstream init script
	rm -f debian/tmp/etc/init.d/clickhouse-server
	# Update upstream config file with Debian paths
	sed -i 's/<path>.*<\/path>/<path>\/var\/lib\/clickhouse<\/path>/' debian/tmp/etc/clickhouse-server/config.xml
	sed -i 's/<tmp_path>.*<\/tmp_path>/<tmp_path>\/var\/lib\/clickhouse\/tmp<\/tmp_path>/' debian/tmp/etc/clickhouse-server/config.xml
	sed -i 's/<log>.*<\/log>/<log>\/var\/log\/clickhouse\/clickhouse-server.log<\/log>/' debian/tmp/etc/clickhouse-server/config.xml
	sed -i 's/<errorlog>.*<\/errorlog>/<errorlog>\/var\/log\/clickhouse\/clickhouse-server.err<\/errorlog>/' debian/tmp/etc/clickhouse-server/config.xml
	dh_install
	dh_missing --list-missing
