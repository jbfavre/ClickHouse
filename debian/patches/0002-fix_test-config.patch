Description: Fix tests
 Default test suite assumes that package is already installed and look for config file in /etc
 Use relative path to allow tests to be ran during package build
Author: Jean Baptiste Favre <debian@jbfavre.org>
Origin: other
Last-Update: 2017-03-20
---
This patch header follows DEP-3: http://dep.debian.net/deps/dep3/
Index: clickhouse/dbms/tests/clickhouse-test
===================================================================
--- clickhouse.orig/dbms/tests/clickhouse-test	2018-01-20 22:10:50.664721034 +0100
+++ clickhouse/dbms/tests/clickhouse-test	2018-01-20 22:10:50.664721034 +0100
@@ -72,14 +72,14 @@
 
     if args.zookeeper is None:
         try:
-            check_call(['grep', '-q', '<zookeeper', '/etc/clickhouse-server/config-preprocessed.xml'])
+            check_call(['grep', '-q', '<zookeeper', '../../debian/clickhouse-server-config-tests.xml'])
             args.zookeeper = True
         except CalledProcessError:
             args.zookeeper = False
 
     if args.shard is None:
         try:
-            check_call(['grep', '-qE', '"127.0.0.2|<listen_host>::</listen_host>"', '/etc/clickhouse-server/config-preprocessed.xml'])
+            check_call(['grep', '-qE', '"127.0.0.2|<listen_host>::</listen_host>"', '../../debian/clickhouse-server-config-tests.xml'])
             args.shard = True
         except CalledProcessError:
             # TODO: false here after setting <listen_host>::1</listen_host>
Index: clickhouse/dbms/tests/queries/0_stateless/00428_partition.sh
===================================================================
--- clickhouse.orig/dbms/tests/queries/0_stateless/00428_partition.sh	2018-01-20 22:10:50.664721034 +0100
+++ clickhouse/dbms/tests/queries/0_stateless/00428_partition.sh	2018-01-20 22:10:50.664721034 +0100
@@ -18,14 +18,14 @@
 $chl "INSERT INTO test.partition_428 (p, k) VALUES(toDate(1), 2)"
 
 for part in `$chl "SELECT name FROM system.parts WHERE database='test' AND table='partition_428'"`; do
-    sudo -n cat $ch_dir/data/test/partition_428/$part/columns.txt | wc -l # 2 header lines + 3 columns
+    cat $ch_dir/data/test/partition_428/$part/columns.txt | wc -l # 2 header lines + 3 columns
 done
 
 $chl "ALTER TABLE test.partition_428 DETACH PARTITION 197001"
 $chl "ALTER TABLE test.partition_428 ATTACH PARTITION 197001"
 
 for part in `$chl "SELECT name FROM system.parts WHERE database='test' AND table='partition_428'"`; do
-    sudo -n cat $ch_dir/data/test/partition_428/$part/columns.txt | wc -l # 2 header lines + 3 columns
+    cat $ch_dir/data/test/partition_428/$part/columns.txt | wc -l # 2 header lines + 3 columns
 done
 
 $chl "ALTER TABLE test.partition_428 MODIFY COLUMN v1 Int8"
Index: clickhouse/dbms/tests/queries/shell_config.sh
===================================================================
--- clickhouse.orig/dbms/tests/queries/shell_config.sh	2018-01-20 22:10:50.664721034 +0100
+++ clickhouse/dbms/tests/queries/shell_config.sh	2018-01-20 22:10:50.664721034 +0100
@@ -3,10 +3,10 @@
 export CLICKHOUSE_CLIENT=${CLICKHOUSE_CLIENT:="${CLICKHOUSE_BINARY}-client"}
 export CLICKHOUSE_LOCAL=${CLICKHOUSE_LOCAL:="${CLICKHOUSE_BINARY}-local"}
 
-export CLICKHOUSE_CONFIG=${CLICKHOUSE_CONFIG:="/etc/clickhouse-server/config.xml"}
+export CLICKHOUSE_CONFIG=${CLICKHOUSE_CONFIG:="../../debian/clickhouse-server-config-tests.xml"}
 export CLICKHOUSE_EXTRACT_CONFIG=${CLICKHOUSE_EXTRACT_CONFIG:="$CLICKHOUSE_BINARY-extract-from-config -c $CLICKHOUSE_CONFIG"}
 
-export CLICKHOUSE_HOST=${CLICKHOUSE_HOST:="localhost"}
+export CLICKHOUSE_HOST=${CLICKHOUSE_HOST:="127.0.0.1"}
 export CLICKHOUSE_PORT_TCP=${CLICKHOUSE_PORT_TCP:=`${CLICKHOUSE_EXTRACT_CONFIG} --try --key=tcp_port 2>/dev/null`} 2>/dev/null
 export CLICKHOUSE_PORT_TCP=${CLICKHOUSE_PORT_TCP:="9000"}
 export CLICKHOUSE_PORT_TCP_SSL=${CLICKHOUSE_PORT_TCP_SSL:=`${CLICKHOUSE_EXTRACT_CONFIG} --try --key=tcp_ssl_port 2>/dev/null`} 2>/dev/null
